<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¥ÙŠØ¬Ø§Ø±Ø§Øª ÙˆÙ‚Ù ÙØ§Ø·Ù…Ø© Ù‡Ø§Ù†Ù… Ø§Ù„Ø¨Ù‚Ù„ÙŠØ© - 2025</title>

  <!-- Google Fonts - Cairo -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet"/>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Fuse.js for fuzzy search -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>

  <!-- PapaParse for CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary: #1e40af;
      --primary-light: #3b82f6;
      --success: #16a34a;
      --warning: #ca8a04;
      --danger: #dc2626;
      --dark: #1e293b;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      min-height: 100vh;
      color: #1f2937;
    }
    header {
      background: linear-gradient(to right, #1e3a8a, #3b82f6);
      color: white;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
    header p { font-size: 1.1rem; opacity: 0.9; }

    .container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; }

    .stats {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      text-align: center;
      font-size: 1.8rem;
      font-weight: 900;
      color: var(--success);
      margin-bottom: 1.5rem;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      margin-bottom: 1.5rem;
      justify-content: center;
    }
    input[type="text"] {
      padding: 0.8rem 1rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1.1rem;
      width: 100%;
      max-width: 400px;
    }
    button {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .btn-add { background:#16a34a; color:white; }
    .btn-refresh { background:#ca8a04; color:white; }
    .btn-export { background:#3b82f6; color:white; }
    .btn-print { background:#6b7280; color:white; }
    button:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 1rem;
      text-align: center;
      border-bottom: 1px solid #eee;
    }
    th {
      background: var(--primary);
      color: white;
      font-weight: 700;
    }
    tr:hover { background:#f8fafc; }
    .rent { color: var(--success); font-weight: bold; }
    .arrears { color: var(--danger); font-weight: bold; }

    .cards { display: none; }
    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr { display: block; }
      thead tr { position: absolute; top: -9999px; left: -9999px; }
      tr { border: 1px solid #ccc; border-radius: 10px; margin-bottom: 1rem; background: white; padding: 1rem; }
      td { border: none; position: relative; padding-left: 50%; text-align: right; }
      td:before { content: attr(data-label); position: absolute; left: 1rem; width: 45%; font-weight: bold; text-align: right; }
      .controls { flex-direction: column; align-items: stretch; }
      input[type="text"] { max-width: 100%; }
    }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .close { float: left; font-size: 2rem; cursor: pointer; }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    input, select {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    #loading {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(30,58,138,0.95);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      z-index: 9999;
    }
    .coin { font-size: 5rem; animation: spin 2s linear infinite; margin-bottom: 1rem; }
    @keyframes spin { from {transform:rotate(0deg);} to {transform:rotate(360deg);} }
  </style>
</head>
<body>

<div id="loading">
  <i class="fas fa-coins coin"></i>
  <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‚Ù ÙØ§Ø·Ù…Ø© Ù‡Ø§Ù†Ù… Ø§Ù„Ø¨Ù‚Ù„ÙŠØ©...</div>
</div>

<header>
  <h1>ÙˆÙ‚Ù ÙØ§Ø·Ù…Ø© Ù‡Ø§Ù†Ù… Ø§Ù„Ø¨Ù‚Ù„ÙŠØ©</h1>
  <p>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„ 2025</p>
</header>

<div class="container">
  <div class="stats" id="totalRent">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</div>

  <div class="controls">
    <input type="text" id="search" placeholder="ğŸ” Ø¨Ø­Ø« Ø°ÙƒÙŠ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„..." />
    <button class="btn-add" onclick="openModal()"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ£Ø¬Ø±</button>
    <button class="btn-refresh" onclick="loadFromGitHub(true)"><i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø±</button>
    <button class="btn-export" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
    <button class="btn-print" onclick="window.print()"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Ù…</th>
        <th>Ø§Ù„Ù†Ø§Ø­ÙŠØ©</th>
        <th>Ø§Ù„Ù†ÙˆØ¹</th>
        <th>Ø§Ù„ÙˆÙ‚Ù</th>
        <th>Ø§Ù„ØµÙØ­Ø©</th>
        <th>Ø§Ù„Ø¬Ø±ÙŠØ¯Ø©</th>
        <th>Ø§Ù„Ø­ÙˆØ¶</th>
        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
        <th>Ø§Ù„Ù…Ø³Ø§Ø­Ø©</th>
        <th class="rent">Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</th>
        <th class="arrears">Ù…ØªØ£Ø®Ø±Ø§Øª</th>
        <th class="rent">Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©</th>
        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2 id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ£Ø¬Ø± Ø¬Ø¯ÙŠØ¯</h2>
    <form id="dataForm">
      <input type="hidden" id="editIndex" />
      <div class="form-grid">
        <input type="text" id="col1" placeholder="Ù…" required />
        <input type="text" id="col2" placeholder="Ø§Ù„Ù†Ø§Ø­ÙŠØ©" required />
        <input type="text" id="col3" placeholder="Ø§Ù„Ù†ÙˆØ¹" required />
        <input type="text" id="col4" placeholder="Ø§Ù„ÙˆÙ‚Ù" required />
        <input type="text" id="col5" placeholder="Ø§Ù„ØµÙØ­Ø©" />
        <input type="text" id="col6" placeholder="Ø§Ù„Ø¬Ø±ÙŠØ¯Ø©" />
        <input type="text" id="col7" placeholder="Ø§Ù„Ø­ÙˆØ¶" />
        <input type="text" id="col8" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±" required />
        <input type="text" id="col9" placeholder="Ø§Ù„Ù…Ø³Ø§Ø­Ø©" />
        <input type="number" id="col10" placeholder="Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©" step="0.01" required oninput="calcAnnual()" />
        <input type="number" id="col11" placeholder="Ù…ØªØ£Ø®Ø±Ø§Øª" step="0.01" value="0" />
      </div>
      <div style="margin-top:1.5rem;text-align:center;">
        <button type="submit" style="background:#16a34a;color:white;padding:1rem 2rem;font-size:1.1rem;">
          <i class="fas fa-save"></i> Ø­ÙØ¸
        </button>
      </div>
    </form>
  </div>
</div>

<script>
const CSV_URL = "https://raw.githubusercontent.com/abukora/waqf-eskan/main/eskan.csv";
let data = [];
let fuse;

const columns = [
  "Ù…", "Ø§Ù„Ù†Ø§Ø­ÙŠØ©", "Ø§Ù„Ù†ÙˆØ¹", "Ø§Ù„ÙˆÙ‚Ù", "Ø§Ù„ØµÙØ­Ø©", "Ø§Ù„Ø¬Ø±ÙŠØ¯Ø©", "Ø§Ù„Ø­ÙˆØ¶",
  "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±", "Ø§Ù„Ù…Ø³Ø§Ø­Ø©", "Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©", "Ù…ØªØ£Ø®Ø±Ø§Øª", "Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©"
];

function calcAnnual() {
  const monthly = parseFloat(document.getElementById("col10").value) || 0;
  document.getElementById("col11").nextElementSibling?.remove();
  const annual = (monthly * 12).toFixed(2);
  if (document.getElementById("col10").value) {
    document.getElementById("col10").parentNode.appendChild(
      Object.assign(document.createElement("small"), {
        textContent: `Ø§Ù„Ø³Ù†ÙˆÙŠØ©: ${annual} Ø¬Ù†ÙŠÙ‡`,
        style: "color:green;font-weight:bold;display:block;margin-top:5px;"
      })
    );
  }
}

async function loadFromGitHub(force = false) {
  const saved = localStorage.getItem("waqfData");
  const savedTime = localStorage.getItem("waqfTime");

  if (!force && saved && savedTime && (Date.now() - savedTime < 24*60*60*1000)) {
    data = JSON.parse(saved);
    initApp();
    document.getElementById("loading").style.display = "none";
    return;
  }

  try {
    const response = await fetch(CSV_URL + "?t=" + Date.now());
    const text = await response.text();
    Papa.parse(text, {
      complete: (results) => {
        data = results.data.slice(1).filter(row => row.length > 5 && row[0]);
 results.data[0]);
        if (saved) {
          const local = JSON.parse(saved);
          data = mergeData(local, data);
        }
        saveAndInit();
      },
      error: () => {
        if (saved) { data = JSON.parse(saved); initApp(); }
      }
    });
  } catch {
    if (saved) { data = JSON.parse(saved); initApp(); }
  }
  document.getElementById("loading").style.display = "none";
}

function mergeData(local, remote) {
  const map = new Map();
  local.forEach(r => map.set(r[0]+"|"+r[7], r));
  remote.forEach(r => {
    const key = r[0]+"|"+r[7];
    if (!map.has(key)) map.set(key, r);
  });
  return Array.from(map.values());
}

function saveAndInit() {
  localStorage.setItem("waqfData", JSON.stringify(data));
  localStorage.setItem("waqfTime", Date.now());
  initApp();
}

function initApp() {
  fuse = new Fuse(data, {
    keys: columns.map((_,i) => i.toString()),
    threshold: 0.3,
    includeScore: false
  });
  renderTable(data);
  calcTotal();
}

function renderTable(records) {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  records.forEach((row, idx) => {
    const tr = document.createElement("tr");
    row.forEach((cell, i) => {
      if (i >= 12) return;
      const td = document.createElement("td");
      td.textContent = cell || "";
      if (i === 9 || i === 11) td.className = "rent";
      if (i === 10) td.className = "arrears";
      if (i >= columns.length) return;
      td.dataset.label = columns[i] + ": ";
      tr.appendChild(td);
    });
    // Annual rent
    const monthly = parseFloat(row[9]) || 0;
    const annual = (monthly * 12).toFixed(2);
    const tdAnnual = document.createElement("td");
    tdAnnual.className = "rent";
    tdAnnual.textContent = annual;
    tdAnnual.dataset.label = "Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©: ";
    tr.appendChild(tdAnnual);

    // Actions
    const tdAct = document.createElement("td");
    tdAct.innerHTML = `
      <button onclick="editRow(${idx})" style="background:#3b82f6;color:white;margin:0.2rem;padding:0.5rem 1rem;"><i class="fas fa-edit"></i></button>
      <button onclick="deleteRow(${idx})" style="background:#dc2626;color:white;margin:0.2rem;padding:0.5rem 1rem;"><i class="fas fa-trash"></i></button>
    `;
    tr.appendChild(tdAct);
    tbody.appendChild(tr);
  });
}

function calcTotal() {
  const total = data.reduce((sum, row) => sum + (parseFloat(row[9]) || 0) * 12, 0);
  document.getElementById("totalRent").textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ø§Ù„Ø³Ù†ÙˆÙŠØ©: ${total.toLocaleString('ar-EG')} Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ`;
}

document.getElementById("search").addEventListener("input", (e) => {
  const term = e.target.value;
  if (!term) { renderTable(data); return; }
  const results = fuse.search(term);
  renderTable(results.map(r => r.item));
});

function openModal() {
  document.getElementById("modal").style.display = "flex";
  document.getElementById("modalTitle").textContent = "Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ£Ø¬Ø± Ø¬Ø¯ÙŠØ¯";
  document.getElementById("dataForm").reset();
  document.getElementById("editIndex").value = "";
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}

document.getElementById("dataForm").onsubmit = (e) => {
  e.preventDefault();
  const row = [];
  for (let i = 1; i <= 11; i++) {
    row.push(document.getElementById("col"+i).value.trim());
  }
  const monthly = parseFloat(row[9]) || 0;
  row[11] = (monthly * 12).toFixed(2);

  const idx = document.getElementById("editIndex").value;
  if (idx === "") {
    data.push(row);
  } else {
    data[idx] = row;
  }
  localStorage.setItem("waqfData", JSON.stringify(data));
  closeModal();
  initApp();
};

function editRow(idx) {
  const row = data[idx];
  for (let i = 0; i < row.length; i++) {
    const el = document.getElementById("col"+(i+1));
    if (el) el.value = row[i] || "";
  }
  document.getElementById("editIndex").value = idx;
  document.getElementById("modalTitle").textContent = "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±";
  openModal();
}

function deleteRow(idx) {
  if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ")) {
    data.splice(idx, 1);
    localStorage.setItem("waqfData", JSON.stringify(data));
    initApp();
  }
}

function exportToExcel() {
  const exportData = data.map(row => {
    const monthly = parseFloat(row[9]) || 0;
    const obj = {};
    columns.forEach((c,i) => obj[c] = row[i] || "");
    obj["Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©"] = (monthly * 12).toFixed(2);
    return obj;
  });

  const ws = XLSX.utils.json_to_sheet(exportData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ø§Ù„ÙˆÙ‚Ù");
  XLSX.writeFile(wb, "ÙˆÙ‚Ù_ÙØ§Ø·Ù…Ø©_Ù‡Ø§Ù†Ù…_Ø§Ù„Ø¨Ù‚Ù„ÙŠØ©_2025.xlsx");
}

// Start
loadFromGitHub();
window.onclick = (e) => { if (e.target === document.getElementById("modal")) closeModal(); };
</script>
</body>
</html>
